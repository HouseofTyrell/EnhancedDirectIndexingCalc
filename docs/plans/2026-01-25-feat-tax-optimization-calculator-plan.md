---
title: "feat: Interactive Tax Optimization Calculator for QFAF + EDI Strategies"
type: feat
date: 2026-01-25
revised: 2026-01-25
revision_note: Simplified based on DHH, Kieran, and Simplicity reviewer feedback
---

# Interactive Tax Optimization Calculator for QFAF + EDI Strategies

## Overview

Build an interactive React/TypeScript calculator that visualizes the tax alpha generated by pairing Quantinno's Fundamental Arbitrage Fund LP (QFAF) with Enhanced Direct Indexing (EDI) over a 10-year horizon.

**Core insight**: QFAF generates short-term gains; EDI generates short-term losses. The 17% rate differential (40.8% ST vs 23.8% LT) creates permanent tax savings when these offset.

### Design Principles (Post-Review)

1. **Ship the calculator, delete the architecture** - No classes, no engines, just functions
2. **One form, one scenario** - No modes, no multi-scenario comparison for MVP
3. **5 states + Other** - Not 50 states on day one
4. **~500-1000 lines total** - If it's more, we're over-engineering
5. **Print CSS for export** - No PDF libraries, no Excel, no PowerPoint

---

## Problem Statement

Clients struggle to understand the quantitative tax benefits of combining QFAF and EDI. An interactive calculator will:

1. **Demonstrate value** - Show tax alpha in client's specific situation
2. **Support advisor conversations** - Generate printable projections
3. **Differentiate Quantinno** - Sophisticated tool competitors lack

---

## Tax Character Mismatch (The Math)

| Source | Generates | Offsets | Rate |
|--------|-----------|---------|------|
| QFAF | Short-term gains (70%) | EDI short-term losses | 40.8% |
| EDI | Short-term losses (85%) | QFAF short-term gains | 40.8% |
| EDI | Long-term gains (90% of realized) | Preferential rate | 23.8% |

**Tax Alpha** = ST losses offset ST gains at 40.8%, but EDI's gains are taxed at 23.8%. The **17% spread** is permanent savings, not deferral.

---

## Research Findings (Retained from Original)

### Strategy Benchmarks

**QFAF Defaults**:
- Expected return: 7%
- ST gain %: 70%
- LT gain %: 15%
- Ordinary loss %: 15%

**EDI Defaults** (harvesting decay curve):
| Year | Rate |
|------|------|
| 1 | 5% |
| 2 | 4% |
| 3 | 3% |
| 4 | 2% |
| 5 | 1.5% |
| 6-10 | 1% |

- Loss character: 85% ST, 15% LT
- Realized gain character: 90% LT, 10% ST

### IRS Rules

- **§1211**: Capital losses limited to $3,000/year against ordinary income
- **§461(l)**: Excess business loss limit $313K single / $626K MFJ (2025)
- Carryforwards: Unlimited duration, track ST/LT separately

### State Tax (MVP States)

| State | Rate | Treatment |
|-------|------|-----------|
| California | 13.3% | Ordinary income |
| New York | 10.9% | Ordinary income |
| Texas | 0% | No state tax |
| Florida | 0% | No state tax |
| Washington | 7%/9.9% | 7% up to $1M, 9.9% above |
| Other | User input | Manual rate entry |

---

## Proposed Solution

### Architecture (Simplified)

```
src/
├── Calculator.tsx      # Main component with form + display (~400 lines)
├── WealthChart.tsx     # Recharts line chart (~100 lines)
├── ResultsTable.tsx    # Year-by-year table (~150 lines)
├── calculator.ts       # Pure calculation functions (~250 lines)
├── taxData.ts          # Federal brackets + 5 states (~150 lines)
├── types.ts            # 3 interfaces (~50 lines)
└── index.tsx           # App entry point
```

**Total: ~1,100 lines** (including imports, JSX, styling)

### Data Model (Flat, Simple)

```typescript
// types.ts

interface CalculatorInputs {
  // Client profile
  investmentAmount: number;
  filingStatus: 'single' | 'mfj' | 'mfs' | 'hoh';
  stateCode: string;  // 'CA' | 'NY' | 'TX' | 'FL' | 'WA' | 'OTHER'
  stateRate: number;  // For 'OTHER', user enters manually
  annualIncome: number;

  // Allocation
  ediAllocation: number;  // 0-1, QFAF gets the rest

  // Strategy assumptions (with defaults, expandable in "Advanced" section)
  qfafReturn: number;           // default: 0.07
  qfafStGainPct: number;        // default: 0.70
  ediReturn: number;            // default: 0.08
  ediHarvestingYear1: number;   // default: 0.05

  // Carryforwards (optional, default 0)
  existingStLossCarryforward: number;
  existingLtLossCarryforward: number;
}

interface YearResult {
  year: number;

  // Portfolio values
  qfafValue: number;
  ediValue: number;
  totalValue: number;

  // Tax events
  stGainsGenerated: number;   // From QFAF
  stLossesHarvested: number;  // From EDI
  ltGainsRealized: number;    // From EDI
  netStGainLoss: number;

  // Taxes
  federalTax: number;
  stateTax: number;
  totalTax: number;

  // Comparison
  baselineTax: number;        // What tax would be without optimization
  taxSavings: number;         // baselineTax - totalTax

  // Carryforward balance (end of year)
  stLossCarryforward: number;
  ltLossCarryforward: number;
}

interface CalculationResult {
  years: YearResult[];
  summary: {
    totalTaxSavings: number;
    finalPortfolioValue: number;
    effectiveTaxAlpha: number;  // Annualized
  };
}
```

### Calculation Functions (Pure, No Classes)

```typescript
// calculator.ts

export function calculate(inputs: CalculatorInputs): CalculationResult {
  const years: YearResult[] = [];
  let qfafValue = inputs.investmentAmount * (1 - inputs.ediAllocation);
  let ediValue = inputs.investmentAmount * inputs.ediAllocation;
  let stCarryforward = inputs.existingStLossCarryforward;
  let ltCarryforward = inputs.existingLtLossCarryforward;

  for (let year = 1; year <= 10; year++) {
    const result = calculateYear(
      year,
      qfafValue,
      ediValue,
      stCarryforward,
      ltCarryforward,
      inputs
    );

    years.push(result);
    qfafValue = result.qfafValue;
    ediValue = result.ediValue;
    stCarryforward = result.stLossCarryforward;
    ltCarryforward = result.ltLossCarryforward;
  }

  return {
    years,
    summary: calculateSummary(years, inputs),
  };
}

function calculateYear(
  year: number,
  qfafValue: number,
  ediValue: number,
  stCarryforward: number,
  ltCarryforward: number,
  inputs: CalculatorInputs
): YearResult {
  // QFAF generates returns and ST gains
  const qfafReturn = qfafValue * inputs.qfafReturn;
  const stGainsGenerated = qfafReturn * inputs.qfafStGainPct;

  // EDI generates returns and harvests losses
  const ediReturn = ediValue * inputs.ediReturn;
  const harvestingRate = getHarvestingRate(year, inputs.ediHarvestingYear1);
  const stLossesHarvested = ediValue * harvestingRate * 0.85;  // 85% ST
  const ltLossesHarvested = ediValue * harvestingRate * 0.15;  // 15% LT

  // EDI realizes some gains (2% of portfolio, 90% LT)
  const realizedGains = ediValue * 0.02;
  const ltGainsRealized = realizedGains * 0.90;

  // Net positions
  const netStGainLoss = stGainsGenerated - stLossesHarvested - stCarryforward;
  const netLtGainLoss = ltGainsRealized - ltLossesHarvested - ltCarryforward;

  // Calculate taxes
  const { federalTax, stateTax, newStCarryforward, newLtCarryforward } =
    calculateTaxes(netStGainLoss, netLtGainLoss, inputs);

  // Baseline: what if all gains taxed at ST rates?
  const baselineTax = calculateBaselineTax(stGainsGenerated + ltGainsRealized, inputs);

  return {
    year,
    qfafValue: qfafValue + qfafReturn,
    ediValue: ediValue + ediReturn,
    totalValue: qfafValue + qfafReturn + ediValue + ediReturn,
    stGainsGenerated,
    stLossesHarvested,
    ltGainsRealized,
    netStGainLoss: Math.max(0, netStGainLoss),
    federalTax,
    stateTax,
    totalTax: federalTax + stateTax,
    baselineTax,
    taxSavings: baselineTax - (federalTax + stateTax),
    stLossCarryforward: newStCarryforward,
    ltLossCarryforward: newLtCarryforward,
  };
}

function getHarvestingRate(year: number, year1Rate: number): number {
  // Decay curve: Year 1 = input, then decreases
  const rates = [year1Rate, 0.04, 0.03, 0.02, 0.015, 0.01, 0.01, 0.01, 0.01, 0.01];
  return rates[year - 1] ?? 0.01;
}

function calculateTaxes(
  netStGainLoss: number,
  netLtGainLoss: number,
  inputs: CalculatorInputs
): { federalTax: number; stateTax: number; newStCarryforward: number; newLtCarryforward: number } {
  // Apply §1211 limitation ($3,000 against ordinary income)
  let taxableSt = netStGainLoss;
  let taxableLt = netLtGainLoss;
  let newStCarryforward = 0;
  let newLtCarryforward = 0;

  if (netStGainLoss < 0) {
    // Can offset up to $3,000 against ordinary income
    const offsetUsed = Math.min(Math.abs(netStGainLoss), 3000);
    newStCarryforward = Math.abs(netStGainLoss) - offsetUsed;
    taxableSt = 0;
  }

  if (netLtGainLoss < 0) {
    newLtCarryforward = Math.abs(netLtGainLoss);
    taxableLt = 0;
  }

  // Federal rates
  const stRate = getFederalStRate(inputs.annualIncome, inputs.filingStatus);
  const ltRate = getFederalLtRate(inputs.annualIncome, inputs.filingStatus);

  const federalTax = (taxableSt * stRate) + (taxableLt * ltRate);

  // State tax (simplified: all gains at state rate)
  const stateRate = inputs.stateCode === 'OTHER'
    ? inputs.stateRate
    : getStateRate(inputs.stateCode);
  const stateTax = (taxableSt + taxableLt) * stateRate;

  return { federalTax, stateTax, newStCarryforward, newLtCarryforward };
}

function calculateBaselineTax(totalGains: number, inputs: CalculatorInputs): number {
  // All gains taxed at ordinary income rates (no optimization)
  const stRate = getFederalStRate(inputs.annualIncome, inputs.filingStatus);
  const stateRate = inputs.stateCode === 'OTHER'
    ? inputs.stateRate
    : getStateRate(inputs.stateCode);
  return totalGains * (stRate + stateRate);
}

function calculateSummary(years: YearResult[], inputs: CalculatorInputs) {
  const totalTaxSavings = years.reduce((sum, y) => sum + y.taxSavings, 0);
  const finalPortfolioValue = years[9].totalValue;
  const effectiveTaxAlpha = totalTaxSavings / inputs.investmentAmount / 10;  // Annualized

  return { totalTaxSavings, finalPortfolioValue, effectiveTaxAlpha };
}
```

### UI Component (Single Main Component)

```typescript
// Calculator.tsx

import { useState, useMemo } from 'react';
import { calculate, CalculatorInputs, CalculationResult } from './calculator';
import { WealthChart } from './WealthChart';
import { ResultsTable } from './ResultsTable';
import { DEFAULTS, STATES } from './taxData';

export function Calculator() {
  const [inputs, setInputs] = useState<CalculatorInputs>(DEFAULTS);
  const [showAdvanced, setShowAdvanced] = useState(false);

  const results = useMemo(() => calculate(inputs), [inputs]);

  const updateInput = <K extends keyof CalculatorInputs>(
    key: K,
    value: CalculatorInputs[K]
  ) => {
    setInputs(prev => ({ ...prev, [key]: value }));
  };

  return (
    <div className="calculator">
      <h1>Tax Optimization Calculator</h1>

      {/* Basic Inputs */}
      <section className="inputs">
        <div className="input-group">
          <label>Investment Amount</label>
          <input
            type="number"
            value={inputs.investmentAmount}
            onChange={e => updateInput('investmentAmount', Number(e.target.value))}
          />
        </div>

        <div className="input-group">
          <label>Filing Status</label>
          <select
            value={inputs.filingStatus}
            onChange={e => updateInput('filingStatus', e.target.value as any)}
          >
            <option value="single">Single</option>
            <option value="mfj">Married Filing Jointly</option>
            <option value="mfs">Married Filing Separately</option>
            <option value="hoh">Head of Household</option>
          </select>
        </div>

        <div className="input-group">
          <label>State</label>
          <select
            value={inputs.stateCode}
            onChange={e => updateInput('stateCode', e.target.value)}
          >
            {STATES.map(s => (
              <option key={s.code} value={s.code}>{s.name}</option>
            ))}
          </select>
        </div>

        {inputs.stateCode === 'OTHER' && (
          <div className="input-group">
            <label>State Tax Rate (%)</label>
            <input
              type="number"
              step="0.1"
              value={inputs.stateRate * 100}
              onChange={e => updateInput('stateRate', Number(e.target.value) / 100)}
            />
          </div>
        )}

        <div className="input-group">
          <label>Annual Income</label>
          <input
            type="number"
            value={inputs.annualIncome}
            onChange={e => updateInput('annualIncome', Number(e.target.value))}
          />
        </div>

        <div className="input-group">
          <label>EDI Allocation ({Math.round(inputs.ediAllocation * 100)}%)</label>
          <input
            type="range"
            min="0"
            max="1"
            step="0.05"
            value={inputs.ediAllocation}
            onChange={e => updateInput('ediAllocation', Number(e.target.value))}
          />
          <span className="allocation-display">
            QFAF: {Math.round((1 - inputs.ediAllocation) * 100)}% /
            EDI: {Math.round(inputs.ediAllocation * 100)}%
          </span>
        </div>
      </section>

      {/* Advanced Settings (Collapsible) */}
      <details open={showAdvanced} onToggle={() => setShowAdvanced(!showAdvanced)}>
        <summary>Advanced Settings</summary>
        <section className="advanced-inputs">
          <div className="input-group">
            <label>QFAF Expected Return (%)</label>
            <input
              type="number"
              step="0.5"
              value={inputs.qfafReturn * 100}
              onChange={e => updateInput('qfafReturn', Number(e.target.value) / 100)}
            />
          </div>

          <div className="input-group">
            <label>QFAF ST Gain % of Return</label>
            <input
              type="number"
              step="5"
              value={inputs.qfafStGainPct * 100}
              onChange={e => updateInput('qfafStGainPct', Number(e.target.value) / 100)}
            />
          </div>

          <div className="input-group">
            <label>EDI Expected Return (%)</label>
            <input
              type="number"
              step="0.5"
              value={inputs.ediReturn * 100}
              onChange={e => updateInput('ediReturn', Number(e.target.value) / 100)}
            />
          </div>

          <div className="input-group">
            <label>EDI Year 1 Harvesting Rate (%)</label>
            <input
              type="number"
              step="0.5"
              value={inputs.ediHarvestingYear1 * 100}
              onChange={e => updateInput('ediHarvestingYear1', Number(e.target.value) / 100)}
            />
          </div>

          <div className="input-group">
            <label>Existing ST Loss Carryforward</label>
            <input
              type="number"
              value={inputs.existingStLossCarryforward}
              onChange={e => updateInput('existingStLossCarryforward', Number(e.target.value))}
            />
          </div>

          <div className="input-group">
            <label>Existing LT Loss Carryforward</label>
            <input
              type="number"
              value={inputs.existingLtLossCarryforward}
              onChange={e => updateInput('existingLtLossCarryforward', Number(e.target.value))}
            />
          </div>
        </section>
      </details>

      {/* Results */}
      <section className="results">
        <div className="summary-cards">
          <div className="card">
            <h3>10-Year Tax Savings</h3>
            <p className="big-number">${results.summary.totalTaxSavings.toLocaleString()}</p>
          </div>
          <div className="card">
            <h3>Final Portfolio Value</h3>
            <p className="big-number">${results.summary.finalPortfolioValue.toLocaleString()}</p>
          </div>
          <div className="card">
            <h3>Annualized Tax Alpha</h3>
            <p className="big-number">{(results.summary.effectiveTaxAlpha * 100).toFixed(2)}%</p>
          </div>
        </div>

        <WealthChart data={results.years} />
        <ResultsTable data={results.years} />
      </section>

      {/* Print button */}
      <button className="print-btn" onClick={() => window.print()}>
        Print / Save as PDF
      </button>

      {/* Disclaimer */}
      <footer className="disclaimer">
        <p>
          This calculator provides estimates for illustrative purposes only.
          Actual tax outcomes depend on individual circumstances.
          Consult a qualified tax advisor before making investment decisions.
        </p>
      </footer>
    </div>
  );
}
```

### Tax Data (5 States + Federal)

```typescript
// taxData.ts

export const STATES = [
  { code: 'CA', name: 'California', rate: 0.133 },
  { code: 'NY', name: 'New York', rate: 0.109 },
  { code: 'TX', name: 'Texas', rate: 0 },
  { code: 'FL', name: 'Florida', rate: 0 },
  { code: 'WA', name: 'Washington', rate: 0.07 },  // Simplified: using 7% flat
  { code: 'OTHER', name: 'Other (enter rate)', rate: 0 },
];

export function getStateRate(code: string): number {
  return STATES.find(s => s.code === code)?.rate ?? 0;
}

// Federal brackets for 2025 (MFJ shown, others similar structure)
const FEDERAL_BRACKETS_MFJ = [
  { min: 0, max: 23850, rate: 0.10 },
  { min: 23850, max: 96950, rate: 0.12 },
  { min: 96950, max: 206700, rate: 0.22 },
  { min: 206700, max: 394600, rate: 0.24 },
  { min: 394600, max: 501050, rate: 0.32 },
  { min: 501050, max: 751600, rate: 0.35 },
  { min: 751600, max: Infinity, rate: 0.37 },
];

export function getFederalStRate(income: number, status: string): number {
  // Simplified: return marginal rate for income level
  const brackets = FEDERAL_BRACKETS_MFJ;  // TODO: Add other filing statuses
  for (let i = brackets.length - 1; i >= 0; i--) {
    if (income >= brackets[i].min) {
      return brackets[i].rate + 0.038;  // Add NIIT for high earners
    }
  }
  return 0.10;
}

export function getFederalLtRate(income: number, status: string): number {
  // Simplified LTCG brackets
  if (income > 583750) return 0.20 + 0.038;  // 20% + NIIT
  if (income > 89250) return 0.15 + 0.038;   // 15% + NIIT
  return 0;
}

export const DEFAULTS: CalculatorInputs = {
  investmentAmount: 1000000,
  filingStatus: 'mfj',
  stateCode: 'CA',
  stateRate: 0,
  annualIncome: 500000,
  ediAllocation: 0.5,
  qfafReturn: 0.07,
  qfafStGainPct: 0.70,
  ediReturn: 0.08,
  ediHarvestingYear1: 0.05,
  existingStLossCarryforward: 0,
  existingLtLossCarryforward: 0,
};
```

---

## Implementation Phases (Simplified)

### Phase 1: MVP (Ship This)

**Goal**: Working calculator that demonstrates tax alpha

**Tasks**:
- [x] Initialize Vite + React + TypeScript project
- [x] Create `types.ts` with 3 interfaces
- [x] Implement `calculations.ts` with pure functions
- [x] Implement `taxData.ts` with 5 states + federal brackets
- [x] Build `Calculator.tsx` main component with form
- [x] Build `WealthChart.tsx` with Recharts
- [x] Build `ResultsTable.tsx` with year-by-year data
- [x] Add print CSS for clean PDF export
- [x] Basic responsive styling
- [ ] Deploy to Vercel/Netlify

**Deliverable**: Usable calculator at a public URL

**Estimated effort**: 2-3 days

### Phase 2: Iterate Based on Feedback

**Only if users request**:
- [ ] Add more states to database
- [ ] Add scenario comparison (if frequently requested)
- [ ] Add more visualizations (waterfall chart)
- [ ] Add Excel export
- [ ] Add leverage/margin modeling
- [ ] Add year-by-year assumption overrides

**Do NOT pre-build these features.**

---

## Acceptance Criteria

### Functional
- [ ] Calculator accepts investment amount, income, state, allocation
- [ ] Calculations produce reasonable results (validated against 3 manual examples)
- [ ] 10-year projection displays in chart and table
- [ ] Tax savings clearly shown
- [ ] Print produces clean PDF

### Non-Functional
- [ ] Page loads in < 2s
- [ ] Calculations update instantly on input change
- [ ] Works in Chrome, Firefox, Safari

### Out of Scope for MVP
- Multi-scenario comparison
- 50-state database
- Excel/PowerPoint export
- At-risk/passive activity rules
- Year-by-year overrides
- Sankey diagrams
- Web workers
- Authentication/saved scenarios

---

## File Checklist

```
src/
├── Calculator.tsx      ☐ Main component
├── WealthChart.tsx     ☐ Recharts line chart
├── ResultsTable.tsx    ☐ Year-by-year table
├── calculator.ts       ☐ Pure calculation functions
├── taxData.ts          ☐ Federal brackets + 5 states
├── types.ts            ☐ 3 interfaces
├── index.tsx           ☐ App entry
├── index.css           ☐ Styles + print CSS
└── print.css           ☐ Print-specific styles
```

---

## Test Scenarios (Manual Validation)

### Scenario 1: California High Earner
- Investment: $1,000,000
- Income: $500,000
- State: CA
- Allocation: 50/50
- Expected: ~$150,000+ tax savings over 10 years

### Scenario 2: Texas No State Tax
- Investment: $1,000,000
- Income: $500,000
- State: TX
- Allocation: 50/50
- Expected: Lower savings (no state tax benefit)

### Scenario 3: Heavy EDI Allocation
- Investment: $1,000,000
- Income: $500,000
- State: NY
- Allocation: 70% EDI / 30% QFAF
- Expected: More harvesting, but less QFAF gains to offset

---

## What We Cut (And Why)

| Feature | Why Cut |
|---------|---------|
| Three complexity modes | One form with accordion is simpler |
| Multi-scenario comparison | Users can re-run with different inputs |
| 50 states | 5 states cover 90%+ of HNW clients |
| Excel/PPT export | Print to PDF is free and sufficient |
| Class-based engine | Pure functions are simpler and testable |
| Context + Reducer | useState handles this fine |
| 26 components | 7 files is enough |
| Sankey diagrams | Tables are clearer |
| Year-by-year overrides | Single assumptions per run |
| Collateral-based sizing | Percentage allocation is intuitive |
| Web workers | Won't need them for this calculation volume |
| ERD diagrams | It's client-side state, not a database |

---

## References

### Tax Rules
- [26 U.S. Code § 1211 - Capital Loss Limitation](https://www.law.cornell.edu/uscode/text/26/1211)
- [IRS Publication 925 - Passive Activity Rules](https://www.irs.gov/publications/p925)
- [Tax Foundation - State Capital Gains Rates](https://taxfoundation.org/data/all/state/state-capital-gains-tax-rates-2024/)

### Strategy Research
- [J.P. Morgan - Tax-Loss Harvesting](https://privatebank.jpmorgan.com/nam/en/insights/markets-and-investing/ideas-and-insights/heres-how-to-make-your-tax-loss-harvesting-strategy-do-more-for-you)
- [AQR - Tax-Aware Long-Short](https://www.aqr.com/Insights/Research/Tax-Aware-Investing)
- [Quantinno Insights](https://www.quantinno.com/insights)

---

## Summary

This is a calculator. It takes numbers, does math, shows a chart. Ship the simple version, get feedback, iterate.

**Lines of code target: ~1,000**
**Files: 7**
**Days to MVP: 2-3**
